@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Mordecai.Web.Data
@attribute [Authorize(Policy = "AdminOnly")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Admin Dashboard - Mordecai MUD</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Admin Dashboard</h1>
            <p class="lead">Welcome to the Mordecai MUD administration panel.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-map-marker text-primary me-2"></i>
                        World Builder
                    </h5>
                    <p class="card-text">Create and manage zones, rooms, and world geography.</p>
                    <div class="d-grid gap-2">
                        <a href="/admin/zones" class="btn btn-primary">Manage Zones</a>
                        <a href="/admin/rooms" class="btn btn-outline-primary">Manage Rooms</a>
                        <a href="/admin/roomtypes" class="btn btn-outline-secondary">Manage Room Types</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-people text-success me-2"></i>
                        NPCs & Spawners
                    </h5>
                    <p class="card-text">Design NPCs, create spawner templates, and place spawners in rooms.</p>
                    <div class="d-grid gap-2">
                        <a href="/admin/npc-templates" class="btn btn-success">NPC Templates</a>
                        <a href="/admin/spawner-templates" class="btn btn-outline-success">Spawner Templates</a>
                        <a href="/admin/spawner-instances" class="btn btn-outline-secondary">Placed Spawners</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-briefcase text-warning me-2"></i>
                        Items
                    </h5>
                    <p class="card-text">Create weapons, armor, and other items for the game world.</p>
                    <a href="/admin/items" class="btn btn-warning">Manage Items</a>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-task text-info me-2"></i>
                        Quests
                    </h5>
                    <p class="card-text">Design quests and storylines for player progression.</p>
                    <a href="/admin/quests" class="btn btn-info">Manage Quests</a>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-cog text-secondary me-2"></i>
                        Skills
                    </h5>
                    <p class="card-text">Configure skill definitions and progression rates.</p>
                    <a href="/admin/skills" class="btn btn-secondary">Manage Skills</a>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-person text-danger me-2"></i>
                        Players
                    </h5>
                    <p class="card-text">Monitor and manage player accounts and characters.</p>
                    <a href="/admin/players" class="btn btn-danger">Manage Players</a>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-cog text-primary me-2"></i>
                        Game Settings
                    </h5>
                    <p class="card-text">Configure global game settings like starting location and rules.</p>
                    <a href="/admin/settings" class="btn btn-primary">Game Settings</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="oi oi-bar-chart text-dark me-2"></i>
                        System Status
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Players Online</h6>
                                <h4 class="text-primary">@playersOnline</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Total Rooms</h6>
                                <h4 class="text-success">@totalRooms</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Active NPCs</h6>
                                <h4 class="text-warning">@activeNpcs</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Server Uptime</h6>
                                <h4 class="text-info">@serverUptime</h4>
                            </div>
                        </div>
                    </div>
                    <hr class="my-3" />
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Total Zones</h6>
                                <h4 class="text-secondary">@totalZones</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>NPC Templates</h6>
                                <h4 class="text-secondary">@totalNpcTemplates</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Active Combats</h6>
                                <h4 class="text-danger">@activeCombats</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>Total Characters</h6>
                                <h4 class="text-secondary">@totalCharacters</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private static readonly DateTimeOffset ServerStartTime = DateTimeOffset.UtcNow;
    
    private int playersOnline = 0;
    private int totalRooms = 0;
    private int activeNpcs = 0;
    private string serverUptime = "0:00:00";
    private int totalZones = 0;
    private int totalNpcTemplates = 0;
    private int activeCombats = 0;
    private int totalCharacters = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        
        // Count total rooms and zones
        totalRooms = await context.Rooms.CountAsync();
        totalZones = await context.Zones.CountAsync();
        
        // Count active spawned NPCs and templates
        activeNpcs = await context.ActiveSpawns.CountAsync(s => s.IsActive);
        totalNpcTemplates = await context.NpcTemplates.CountAsync();
        
        // Count players online (active in last 15 minutes) and total characters
        var onlineThreshold = DateTimeOffset.UtcNow.AddMinutes(-15);
        playersOnline = await context.Characters
            .CountAsync(c => c.LastPlayedAt != null && c.LastPlayedAt > onlineThreshold);
        totalCharacters = await context.Characters.CountAsync();
        
        // Count active combat sessions
        activeCombats = await context.CombatSessions.CountAsync(s => s.IsActive);
        
        // Calculate server uptime
        var uptime = DateTimeOffset.UtcNow - ServerStartTime;
        serverUptime = uptime.TotalHours >= 24 
            ? $"{(int)uptime.TotalDays}d {uptime:hh\\:mm\\:ss}"
            : uptime.ToString(@"h\:mm\:ss");
    }
}