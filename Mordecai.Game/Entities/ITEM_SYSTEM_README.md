# Item and Inventory System

This document describes the item and inventory system in Mordecai MUD.

## Overview

The item system is built around two core concepts:

1. **Item Templates** - Blueprints that define what an item is (weight, type, properties)
2. **Item Instances** - Actual items in the game world with current state (location, durability, ownership)

## Core Concepts

### Weight and Volume

Every item has two physical properties:

- **Weight** (in pounds) - How heavy the item is
- **Volume** (in cubic feet) - How much space it takes up

Characters have carrying capacity limits based on their **Physicality** attribute. Since Physicality is generated by 4dF (bell curve centered on 10), the capacity formula uses **exponential scaling** to properly reward high values and penalize low ones:

- **Max Weight** = 50 lbs × (1.15 ^ (Physicality - 10))
- **Max Volume** = 10 cu.ft. × (1.15 ^ (Physicality - 10))

**Capacity Examples:**

| Physicality | Max Weight | Max Volume | Notes |
|-------------|------------|------------|-------|
| 6 (rare)    | ~29 lbs    | ~6 cu.ft.  | Very weak, struggles with basics |
| 8 (uncommon)| ~38 lbs    | ~8 cu.ft.  | Weak, limited carrying |
| 10 (average)| 50 lbs     | 10 cu.ft.  | Typical humanoid |
| 12 (uncommon)| ~66 lbs   | ~13 cu.ft. | Strong, noticeable advantage |
| 14 (rare)   | ~87 lbs    | ~17 cu.ft. | Very strong, significant capacity |

Exceeding weight limits may slow movement or prevent it entirely. Exceeding volume limits prevents picking up additional items.

### Item Types

Items are categorized by type:

- **Weapon** - Combat weapons (swords, bows, staves, etc.)
- **Armor** - Protective equipment
- **Container** - Can hold other items (bags, backpacks, quivers, chests)
- **Consumable** - Single-use items (potions, scrolls)
- **Treasure** - Valuable items (gold, gems)
- **Key** - Opens doors or containers
- **Magic** - Magical items with special properties
- **Food** - Restores hunger
- **Drink** - Restores thirst
- **Tool** - Utility items
- **QuestItem** - Required for quests
- **Miscellaneous** - Everything else

### Container System

Containers are special items with `IsContainer = true`. They enable organized storage with the following features:

#### Container Properties

- **ContainerMaxWeight** - Maximum weight of items it can hold
- **ContainerMaxVolume** - Maximum volume of items it can hold
- **ContainerAllowedTypes** - Comma-separated list of allowed item types (empty = any)
- **ContainerWeightReduction** - Weight multiplier for magical containers (1.0 = normal, 0.5 = half weight, 0.0 = weightless)
- **ContainerVolumeReduction** - Volume multiplier for magical containers (1.0 = normal, 0.5 = half volume, 0.0 = no volume)

#### Container Examples

**Backpack (General Storage)**
```csharp
var backpack = new ItemTemplate
{
    Name = "Leather Backpack",
    ItemType = ItemType.Container,
    Weight = 3m,
    Volume = 1m,
    IsContainer = true,
    ContainerMaxWeight = 50m,
    ContainerMaxVolume = 10m,
    ContainerAllowedTypes = null // Can hold anything
};
```

**Quiver (Type-Restricted)**
```csharp
var quiver = new ItemTemplate
{
    Name = "Arrow Quiver",
    ItemType = ItemType.Container,
    Weight = 1m,
    Volume = 0.5m,
    IsContainer = true,
    ContainerMaxWeight = 5m,
    ContainerMaxVolume = 2m,
    ContainerAllowedTypes = "Arrow,Bolt" // Only arrows and bolts
};
```

**Spell Component Pouch**
```csharp
var componentPouch = new ItemTemplate
{
    Name = "Spell Component Pouch",
    ItemType = ItemType.Container,
    Weight = 0.5m,
    Volume = 0.25m,
    IsContainer = true,
    ContainerMaxWeight = 3m,
    ContainerMaxVolume = 1m,
    ContainerAllowedTypes = "SpellComponent,Magic"
};
```

**Bag of Holding (Magical - Reduces Weight/Volume)**
```csharp
var bagOfHolding = new ItemTemplate
{
    Name = "Bag of Holding",
    ItemType = ItemType.Container,
    Weight = 2m,
    Volume = 0.5m,
    IsContainer = true,
    ContainerMaxWeight = 200m,  // Can hold a lot
    ContainerMaxVolume = 40m,
    ContainerWeightReduction = 0.1m,  // Items weigh only 10% of normal
    ContainerVolumeReduction = 0.1m,  // Items take only 10% of normal volume
    Rarity = "Rare"
};
```

**Explanation**: A Bag of Holding with 100 lbs of items inside would only add `2 (bag) + (100 * 0.1) = 12 lbs` to character's carried weight!

#### Container Nesting

Containers can hold other containers, creating nested inventory structures:

```
Character
├─ Backpack (50 lbs capacity)
│  ├─ Small Pouch (5 lbs capacity)
│  │  ├─ Gold Coins
│  │  └─ Gems
│  ├─ Food Items
│  └─ Rope
├─ Quiver (arrows only)
│  └─ Arrows (×20)
└─ Equipped Sword
```

The `ContainerItemId` foreign key on `Item` links to the parent container.

### Item Instances

Each item instance tracks:

- **Location**: Where is it?
  - `CurrentRoomId` - In a room (dropped/spawned)
  - `OwnerCharacterId` - In a character's inventory
  - `ContainerItemId` - Inside another item (container)
  
- **State**: What condition is it in?
  - `StackSize` - How many in this stack (for stackable items)
  - `CurrentDurability` - Current durability (if item has durability)
  - `IsEquipped` - Is it currently equipped?
  - `EquippedSlot` - Which equipment slot (if equipped)
  
- **Ownership**:
  - `IsBound` - Is it bound to the character?
  - `PickedUpAt` - When was it picked up?

### Equipment Slots

Characters can equip items in specific slots:

- **Head** - Helmets, hats, crowns
- **Neck** - Amulets, necklaces
- **Shoulders** - Pauldrons, cloaks
- **Chest** - Armor, robes
- **Back** - Capes, backpacks
- **Wrists** - Bracers, bracelets
- **Hands** - Gauntlets, gloves
- **Waist** - Belts, sashes
- **Legs** - Greaves, pants
- **Feet** - Boots, shoes
- **FingerLeft** - Left ring
- **FingerRight** - Right ring
- **MainHand** - Primary weapon
- **OffHand** - Shield, secondary weapon
- **TwoHand** - Two-handed weapon (occupies both hands)

### Item Bonuses

Items can provide bonuses to characters:

#### Skill Bonuses (`ItemSkillBonus`)

Enhance specific skills:

```csharp
var swordBonus = new ItemSkillBonus
{
    ItemTemplateId = magicSword.Id,
    SkillDefinitionId = swordsSkill.Id,
    BonusType = "FlatBonus",
    BonusValue = 2 // +2 to Swords skill
};
```

Bonus types:
- **FlatBonus** - Added to skill level
- **PercentageBonus** - Multiplies skill effectiveness (10 = 10% bonus)
- **CooldownReduction** - Reduces skill cooldown in seconds

#### Attribute Modifiers (`ItemAttributeModifier`)

Enhance character attributes:

```csharp
var strengthBelt = new ItemAttributeModifier
{
    ItemTemplateId = beltOfGiants.Id,
    AttributeName = "STR",
    ModifierType = "FlatBonus",
    ModifierValue = 3 // +3 Physicality
};
```

Valid attributes: `STR`, `DEX`, `END`, `INT`, `ITT`, `WIL`, `PHY`

### Item Properties

#### Stackability

Some items can stack (arrows, potions, coins):

```csharp
var arrow = new ItemTemplate
{
    Name = "Iron Arrow",
    IsStackable = true,
    MaxStackSize = 50,
    Weight = 0.1m, // Weight per arrow
    Volume = 0.01m // Volume per arrow
};
```

Weight and volume scale with stack size automatically.

#### Binding

Items can bind to characters:

- **BindOnPickup** - Binds when picked up (cannot be traded)
- **BindOnEquip** - Binds when equipped (one-time equip, then bound)
- **IsBound** (on instance) - Current binding state

#### Durability

Items with durability can break:

```csharp
var sword = new ItemTemplate
{
    Name = "Iron Sword",
    HasDurability = true,
    MaxDurability = 100
};
```

Item instances track `CurrentDurability`. When it reaches 0, the item is broken (`IsBroken` property).

#### Rarity

Items have rarity tiers affecting their appearance and value:

- Common
- Uncommon
- Rare
- Epic
- Legendary

### Custom Properties

Both templates and instances have `CustomProperties` JSON fields for flexible data:

**Template Custom Properties** (design-time):
```json
{
  "questFlags": ["dragon_slayer_quest"],
  "enchantments": ["flaming", "keen"],
  "specialAbilities": ["fireball_cast"]
}
```

**Instance Custom Properties** (runtime):
```json
{
  "charges": 3,
  "craftingQuality": 0.95,
  "temporaryBuffs": ["haste"],
  "lastUsedAt": "2025-10-12T10:30:00Z"
}
```

## Inventory Calculations

### Total Weight

Calculated recursively for items with containers:

```csharp
public decimal TotalWeight
{
    get
    {
        var baseWeight = ItemTemplate.Weight * StackSize;
        if (ItemTemplate.IsContainer)
        {
            var containedWeight = ContainedItems.Sum(item => item.TotalWeight);
            var weightReduction = ItemTemplate.ContainerWeightReduction ?? 1.0m;
            return baseWeight + (containedWeight * weightReduction);
        }
        return baseWeight;
    }
}
```

**Magical Container Example:**
- Bag of Holding (weight: 2 lbs, `ContainerWeightReduction = 0.1`)
- Contains: Sword (4 lbs) + Shield (6 lbs) = 10 lbs of items
- Total Weight = 2 + (10 × 0.1) = **3 lbs** (instead of 12 lbs!)

### Character Capacity

The `CharacterInventory` entity tracks:

```csharp
public class CharacterInventory
{
    public Guid CharacterId { get; set; }
    public decimal MaxWeight { get; set; } // Physicality * 10
    public decimal MaxVolume { get; set; } // Physicality * 2
    public DateTimeOffset LastCalculatedAt { get; set; }
}
```

Capacity should be recalculated when:
- Character's Physicality attribute changes
- Character equips/unequips items that affect Physicality
- Character learns skills that affect carrying capacity

## Database Relationships

### Item Instance Location

An item instance can be in exactly one location:

1. **In a room**: `CurrentRoomId` set, others null
2. **In character inventory**: `OwnerCharacterId` set, `CurrentRoomId` null
3. **In a container**: `ContainerItemId` set, may also have `OwnerCharacterId`

### Navigation Properties

```
ItemTemplate
  └─ Items (collection) - All instances of this template
  └─ SkillBonuses (collection) - Skill bonuses provided
  └─ AttributeModifiers (collection) - Attribute modifiers provided

Item
  ├─ ItemTemplate (reference) - The template this is an instance of
  ├─ CurrentRoom (reference) - Room it's in (if applicable)
  ├─ OwnerCharacter (reference) - Character who owns it (if applicable)
  ├─ ContainerItem (reference) - Container it's in (if applicable)
  └─ ContainedItems (collection) - Items inside this item (if it's a container)

Character
  └─ (Items via OwnerCharacterId) - All items owned by this character
  └─ CharacterInventory (one-to-one) - Capacity tracking
```

## Indexes

Key indexes for performance:

- `ItemTemplate`: Name, ItemType, IsActive, IsContainer, Rarity
- `Item`: ItemTemplateId, CurrentRoomId, OwnerCharacterId, ContainerItemId, (OwnerCharacterId + IsEquipped), CreatedAt
- `ItemSkillBonus`: ItemTemplateId, SkillDefinitionId, (ItemTemplateId + SkillDefinitionId)
- `ItemAttributeModifier`: ItemTemplateId, AttributeName, (ItemTemplateId + AttributeName)

## Usage Examples

### Creating an Item Template

```csharp
var sword = new ItemTemplate
{
    Name = "Steel Longsword",
    Description = "A well-balanced longsword forged from steel.",
    ShortDescription = "steel longsword",
    ItemType = ItemType.Weapon,
    WeaponType = WeaponType.Sword,
    Weight = 4m,
    Volume = 0.5m,
    Value = 150,
    HasDurability = true,
    MaxDurability = 100,
    Rarity = "Common",
    CreatedBy = userId
};
```

### Spawning an Item Instance

```csharp
var swordInstance = new Item
{
    ItemTemplateId = sword.Id,
    CurrentRoomId = startingRoom.Id,
    StackSize = 1,
    CurrentDurability = sword.MaxDurability,
    CreatedAt = DateTimeOffset.UtcNow
};
```

### Moving Item to Character Inventory

```csharp
// Character picks up item from room
item.CurrentRoomId = null;
item.OwnerCharacterId = character.Id;
item.PickedUpAt = DateTimeOffset.UtcNow;

// Check if it should bind
if (item.ItemTemplate.BindOnPickup)
{
    item.IsBound = true;
}
```

### Putting Item in Container

```csharp
// Character puts item in backpack
item.ContainerItemId = backpack.Id;
// OwnerCharacterId can remain set - item is owned by character, stored in container
```

### Equipping an Item

```csharp
// Character equips sword
item.IsEquipped = true;
item.EquippedSlot = ArmorSlot.MainHand;

// Check if it should bind
if (item.ItemTemplate.BindOnEquip && !item.IsBound)
{
    item.IsBound = true;
}
```

### Checking Container Capacity

```csharp
// Check if item can fit in container
var container = await context.Items
    .Include(i => i.ItemTemplate)
    .Include(i => i.ContainedItems)
        .ThenInclude(ci => ci.ItemTemplate)
    .FirstOrDefaultAsync(i => i.Id == containerId);

if (container?.ItemTemplate.IsContainer == true)
{
    var currentWeight = container.ContainedItems.Sum(i => i.TotalWeight);
    var currentVolume = container.ContainedItems.Sum(i => i.TotalVolume);
    
    if (currentWeight + itemToAdd.TotalWeight <= container.ItemTemplate.ContainerMaxWeight &&
        currentVolume + itemToAdd.TotalVolume <= container.ItemTemplate.ContainerMaxVolume)
    {
        // Item can fit
        itemToAdd.ContainerItemId = container.Id;
    }
}
```

## Future Enhancements

Planned improvements:

- Item crafting system
- Item enchantment system
- Item set bonuses (when wearing complete sets)
- Item decay/degradation over time
- Item repair system
- Item trading/auction house
- Item transmutation/appearance changes
- Magical item identification
- Cursed items
- Item quality tiers (masterwork, poor quality, etc.)

## See Also

- [Database Design](../../../docs/DATABASE_DESIGN.md) - Full database schema
- [Mordecai Specification](../../../docs/MORDECAI_SPECIFICATION.md) - Game design document
- [SkillEntities.cs](./SkillEntities.cs) - Skill system (for skill bonuses)
