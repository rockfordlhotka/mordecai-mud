# Phase 3 Plan: Messaging & Round Tick

**Created:** 2026-01-30
**Status:** Ready for implementation

## Objective

Broadcast combat actions to room observers and implement health pool drainage for NPCs. The existing system already publishes CombatAction messages - this phase adds NPC health tick processing and timed penalty expiration.

## Gap Analysis

**Already Working:**
- ✅ CombatAction messages published for hits and misses (CombatService lines 246-250, 293-297)
- ✅ CombatStarted/CombatEnded messages published
- ✅ Character pending damage processed by HealthTickBackgroundService
- ✅ ActiveSpawn entities have PendingFatigueDamage/PendingVitalityDamage fields

**Missing:**
- ❌ NPC (ActiveSpawn) pending damage NOT processed by any tick service
- ❌ Timed penalty expiration NOT processed automatically
- ❌ FAT recovery for combat participants NOT implemented

## Tasks

### Task 1: Extend HealthTickBackgroundService for NPCs

**File:** `Mordecai.Web\Services\HealthTickBackgroundService.cs`

Add NPC processing to existing tick loop:

```csharp
private async Task ProcessPendingHealthAsync(CancellationToken cancellationToken)
{
    // ... existing character processing ...
    
    // NEW: Process NPC (ActiveSpawn) pending damage
    await ProcessNpcPendingHealthAsync(context, cancellationToken);
}

private async Task ProcessNpcPendingHealthAsync(ApplicationDbContext context, CancellationToken cancellationToken)
{
    var npcs = await context.ActiveSpawns
        .Where(asp => asp.IsActive && 
               (asp.PendingFatigueDamage != 0 || asp.PendingVitalityDamage != 0))
        .ToListAsync(cancellationToken);
    
    foreach (var npc in npcs)
    {
        ProcessNpcFatiguePool(npc);
        ProcessNpcVitalityPool(npc);
    }
    
    if (npcs.Count > 0)
    {
        await context.SaveChangesAsync(cancellationToken);
    }
}
```

### Task 2: Add Timed Penalty Expiration to Health Tick

**File:** `Mordecai.Web\Services\HealthTickBackgroundService.cs`

Add penalty cleanup to the tick:

```csharp
private async Task ProcessTimedPenaltiesAsync(ApplicationDbContext context, CancellationToken cancellationToken)
{
    var now = DateTimeOffset.UtcNow;
    var participants = await context.CombatParticipants
        .Where(p => p.IsActive && p.TimedPenaltiesJson != null)
        .ToListAsync(cancellationToken);
    
    foreach (var participant in participants)
    {
        var penalties = JsonSerializer.Deserialize<List<TimedPenalty>>(participant.TimedPenaltiesJson!);
        var activePenalties = penalties?.Where(p => p.ExpiresAt > now).ToList();
        
        participant.TimedPenaltiesJson = activePenalties?.Any() == true
            ? JsonSerializer.Serialize(activePenalties)
            : null;
    }
    
    await context.SaveChangesAsync(cancellationToken);
}
```

### Task 3: Add CombatDamageReceived Message (Optional Enhancement)

**File:** `Mordecai.Messaging\Messages\CombatMessages.cs`

Create detailed damage message for participants:

```csharp
public sealed record CombatDamageReceived(
    Guid CharacterId,
    string CharacterName,
    int LocationRoomId,
    int FatigueDamage,
    int VitalityDamage,
    int WoundsInflicted,
    int ArmorAbsorption,
    string AttackerName
) : GameMessage
{
    public override int? RoomId => null; // Personal message
    public override IReadOnlyList<Guid>? TargetCharacterIds => [CharacterId];
}
```

**Note:** This is lower priority since CombatAction already includes damage info. Can defer if time-constrained.

### Task 4: Add Integration Tests

**File:** `Mordecai.Web.Tests\HealthTickNpcTests.cs` (new)

Tests:
1. `ProcessPendingHealth_NpcWithPendingDamage_DrainsPools`
2. `ProcessPendingHealth_NpcFatigueCrash_OverflowsToVitality`
3. `ProcessTimedPenalties_ExpiredPenalties_AreRemoved`

## Implementation Order

1. Task 1 - NPC health tick (core requirement)
2. Task 2 - Timed penalty expiration (completes TICK-04)
3. Task 4 - Tests
4. Task 3 - Optional detailed damage message (if time permits)

## Requirements Mapping

| Requirement | Task | Notes |
|-------------|------|-------|
| MSG-01 | Already done | CombatAction published for hits/misses |
| MSG-02 | Task 3 | Optional - CombatAction already has damage |
| MSG-03 | Already done | Uses RoomId property for scoping |
| TICK-01 | Already done | HealthTickBackgroundService runs every 3s |
| TICK-02 | Deferred | FAT recovery needs "last damage" tracking |
| TICK-03 | Task 1 | Add NPC pending pool drainage |
| TICK-04 | Task 2 | Timed penalty expiration |

**Note:** TICK-02 (FAT recovery in combat) requires tracking "last damage received" timestamp. This adds complexity - recommend deferring to Phase 4 with NPC AI.

## Estimated Time

- Task 1: 15 minutes
- Task 2: 10 minutes
- Task 4: 15 minutes
- Task 3: 10 minutes (optional)
- **Total: ~40-50 minutes**

---

*Plan: 03-01*
*Phase: 03-messaging-round-tick*
