# Phase 2 Plan: Combat Orchestration - Session Lifecycle

**Created:** 2026-01-30
**Status:** Ready for implementation

## Objective

Ensure combat sessions properly orchestrate participant lifecycle: join existing sessions when target is already in combat, track participant state correctly, and clean up on death/flee.

## Gap Analysis

**Existing code (CombatService.InitiateCombatAsync):**
- ✅ Checks if attacker is already in combat (lines 37-43)
- ✅ Creates session and participants if no session exists (lines 55-91)
- ✅ Publishes CombatStarted message (lines 93-101)
- ❌ **Does NOT check if target is already in combat** - creates duplicate session

**Required behavior:**
1. If attacker is in combat → return existing session
2. If target is in combat → add attacker to target's session (NEW)
3. If neither in combat → create new session (existing)

## Tasks

### Task 1: Add Target's Combat Session Check

**File:** `Mordecai.Web\Services\CombatService.cs`

**Change:** After checking attacker's session, also check target's session and join it if exists.

**Location:** Lines 37-43 in `InitiateCombatAsync`

```csharp
// Current (line 37-43):
var existingSession = await GetActiveCombatSessionAsync(attackerId, attackerIsPlayer, cancellationToken);
if (existingSession != null)
{
    return existingSession.Id;
}

// New (after line 43):
// Check if target is already in combat - join their session
var targetSession = await GetActiveCombatSessionAsync(targetId, targetIsPlayer, cancellationToken);
if (targetSession != null)
{
    // Add attacker as new participant to target's session
    var (attackerName, attackerRoomId) = await GetParticipantInfoAsync(attackerId, attackerIsPlayer, cancellationToken);
    
    // Verify same room
    if (attackerRoomId != targetSession.RoomId)
    {
        _logger.LogWarning("Cannot join combat - attacker in different room from combat");
        return null;
    }
    
    var attackerParticipant = new CombatParticipant
    {
        CombatSessionId = targetSession.Id,
        CharacterId = attackerIsPlayer ? attackerId : null,
        ActiveSpawnId = attackerIsPlayer ? null : (await _dbContext.ActiveSpawns
            .Where(asp => asp.NpcId == attackerId && asp.IsActive)
            .Select(asp => (int?)asp.Id)
            .FirstOrDefaultAsync(cancellationToken)),
        ParticipantName = attackerName,
        IsActive = true,
        JoinedAt = DateTimeOffset.UtcNow
    };
    
    _dbContext.CombatParticipants.Add(attackerParticipant);
    await _dbContext.SaveChangesAsync(cancellationToken);
    
    _logger.LogInformation("Attacker {Attacker} joined existing combat session {Session}",
        attackerName, targetSession.Id);
    
    return targetSession.Id;
}
```

### Task 2: Add Integration Test

**File:** `Mordecai.Web.Tests\Services\CombatOrchestrationTests.cs` (new)

**Tests:**
1. `InitiateCombat_WhenTargetAlreadyInCombat_JoinsExistingSession`
2. `InitiateCombat_WhenNeitherInCombat_CreatesNewSession`
3. `InitiateCombat_WhenAttackerAlreadyInCombat_ReturnsExistingSession`
4. `EndCombat_WhenParticipantDies_MarksSessionInactive`
5. `FleeFromCombat_WhenSuccessful_RemovesParticipantAndEndsIfOnlyOneLeft`

### Task 3: Verify Participant State Initialization

**File:** `Mordecai.Web\Services\CombatService.cs`

**Verify:** Ensure participant state fields are properly initialized:
- `IsInParryMode = false` (explicit)
- `TimedPenaltiesJson` = null or "[]" (check handling)
- `JoinedAt = DateTimeOffset.UtcNow` (already set by default)

**Location:** Lines 66-88 in `InitiateCombatAsync` - add explicit initialization if missing.

## Acceptance Criteria

From REQUIREMENTS.md:

- [x] **ORCH-01**: Attacking an NPC creates CombatSession automatically if none exists *(already works)*
- [ ] **ORCH-02**: CombatParticipant entities created for attacker and defender when combat starts *(verify initialization)*
- [x] **ORCH-03**: Combat session ends when participant dies or successfully flees *(already works)*
- [ ] **ORCH-04**: Combat state tracked per participant (parry mode, timed penalties, last attack time) *(verify fields set)*

**Additional verification:**
- [ ] Subsequent attacks against same NPC reuse existing combat session
- [ ] Player attacking NPC already in combat joins that session

## Implementation Order

1. Task 1 - Add target session check (core fix)
2. Task 3 - Verify state initialization (minor)
3. Task 2 - Add tests (validation)

## Estimated Time

- Task 1: 10 minutes
- Task 2: 20 minutes  
- Task 3: 5 minutes
- **Total: ~35 minutes**

---

*Plan: 02-01*
*Phase: 02-combat-orchestration*
