# Plan 06-01: Combat UI Implementation

**Status:** COMPLETE
**Created:** 2026-01-31
**Completed:** 2026-01-31

## Objective

Add visual combat feedback to the game UI including:
- Enhanced health bars showing pending damage/healing
- Collapsible combat log panel
- Color-coded combat messages
- Status indicators for combat states
- NPC health descriptions in messages

## Tasks

### Task 1: Enhanced Health Bars Component ✅
Created `Components/HealthBar.razor` with multi-segment display:
- Blue segment for current value
- Red segment for pending damage
- Green segment for pending healing
- Gray for remaining capacity
- No text/percentages, just visual bars

### Task 2: Combat Panel Component ✅
Created `Components/CombatPanel.razor`:
- Collapsible side panel (collapsed when not in combat)
- 18 line combat log history
- Auto-scroll to latest
- Dedicated combat message display (separate from main feed)

### Task 3: Combat Status Indicators ✅
Created `Components/CombatStatusIndicators.razor`:
- Parry mode toggle/indicator
- Exhausted badge (FAT=0)
- Wounded badge (VIT < 25%)
- Fleeing indicator

### Task 4: Enhanced Combat Message Formatting ✅
Updated `CharacterMessageBroadcastService`:
- Added HTML/CSS classes for combat messages
- Added `GetNpcHealthDescription()` helper
- Classes: combat-start, combat-end, combat-hit-dealt, combat-hit-received, combat-miss, etc.

### Task 5: Combat State Tracking in Play.razor ✅
Added combat state variables:
- `isInCombat` boolean
- `combatSessionId` for current session  
- `combatLog` list for panel
- `isParryMode`, `isFleeing` states
- Combat state refresh in health tick loop

### Task 6: Integrate Components into Play.razor ✅
- Replaced existing health bars with HealthBar component
- Added CombatPanel to layout
- Added CombatStatusIndicators to character panel
- Added `TryAddToCombatLog()` to parse combat messages

### Task 7: CSS Styling ✅
Added to `site.css` (~200 lines):
- `.combat-hit-dealt` (green)
- `.combat-hit-received` (red)
- `.combat-miss` (gray)
- `.combat-flee` (yellow)
- `.combat-critical` (bold/bright)
- Health bar segment colors
- Combat panel styles
- Status indicator badges

## Files Created

- `Mordecai.Web/Components/HealthBar.razor`
- `Mordecai.Web/Components/CombatPanel.razor`
- `Mordecai.Web/Components/CombatStatusIndicators.razor`

## Files Modified

- `Mordecai.Web/Pages/Play.razor` - Integrated new components
- `Mordecai.Web/Services/CharacterMessageBroadcastService.cs` - Enhanced formatting
- `Mordecai.Web/Services/CombatService.cs` - Added GetCharacterCombatStateAsync
- `Mordecai.Game/Services/ICombatService.cs` - Added CharacterCombatState record and interface method
- `Mordecai.Web/wwwroot/css/site.css` - Combat styles
- `Mordecai.Web.Tests/NpcAiTests.cs` - Updated stub combat service

## Success Criteria

1. ✅ Health bars show blue (current), red (pending damage), green (pending heal)
2. ✅ Combat panel appears when combat starts, collapses when combat ends
3. ✅ Combat messages color-coded by type
4. ✅ Status indicators show parry mode, exhausted, wounded states
5. ✅ NPC health shown as descriptive text ("badly wounded")
6. ✅ All 102 tests passing
